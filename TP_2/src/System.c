
#include "System.h"
#include <stdlib.h>
#include <stdio.h>
#include <string.h>


#define DEFAULT_SIZE 4

System* system_init()
{
	int i;
	System* system = (System*)malloc(sizeof(System));
	if (system == NULL)
		return NULL;
	system->processes = (Process**)malloc(sizeof(Process*) * DEFAULT_SIZE);
	if (system->processes == NULL)
	{
		free(system);
		return NULL;
	}
	system->ready = process_list_init();
	if (system->ready == NULL)
	{
		free(system->processes);
		free(system);
		return NULL;
	}
	system->interruptions = interruption_array_init();
	if (system->interruptions == NULL)
	{
		free(system->processes);
		process_list_destroy(system->ready);
		free(system);
		return NULL;
	}
	system->size_processes = DEFAULT_SIZE;
	for (i = 0; i < DEFAULT_SIZE; i++)
		system->processes[i] = NULL;
	system->processes[0] = process_init(0, 0);
	if (system->processes[0] == NULL)
	{
		free(system->processes);
		process_list_destroy(system->ready);
		interruption_array_destroy(system->interruptions, TRUE);
		free(system);
		return NULL;
	}
	system->instructions_left = 0;
	system->current = NULL;
	return system;
}

unsigned int system_find_free_id(System* system)
{
	Process** tmp;
	unsigned int i;
	unsigned int new_size;
	for (i = 0; i < system->size_processes; i++)
		if (system->processes == NULL)
			return i;
	new_size = system->size_processes + DEFAULT_SIZE;
	tmp = (Process**)realloc(system->processes, new_size * sizeof(Process*));
	if (tmp == NULL)
		return 0;
	for (i = system->size_processes; i < new_size; i++)
		tmp[i] = NULL;
	i = system->size_processes;
	system->size_processes = new_size;
	system->processes = tmp;
	return i;
}


Process* system_create_process(System* system, unsigned int parent_id)
{
	unsigned int id;
	Process* tmp;
	tmp = system_get_process(system, parent_id);
	if (tmp == NULL)
		return NULL;
	id = system_find_free_id(system);
	if (id == 0)
		return NULL;
	tmp = process_init(id, parent_id);
	if (tmp == NULL)
		return NULL;
	system->processes[tmp->id] = tmp;
	process_list_push(system->ready, tmp);
	printf("%05u - START\n", id);
	return tmp;
}

Process* system_get_process(System* system, unsigned int id)
{
	if (id >= system->size_processes)
		return NULL;
	if (system->processes[id] == NULL)
		return NULL;
	return system->processes[id];
}

void system_ordonancement(System* system)
{
	if (system->current != NULL && system->instructions_left > 0)
		return;
	if (system->current != NULL)
		process_list_push(system->ready, system->current);
	system->current = process_list_pop(system->ready);
	system->instructions_left = 1 + rand() % 5;
}

void system_handle_interruption(System* system)
{
	unsigned int index;
	Interruption* interruption;
	unsigned int size = interruption_array_size(system->interruptions);
	if (size < 1)
		return;
	index = ((unsigned int)rand()) % size;
	interruption = interruption_array_remove(system->interruptions, index);
	switch (interruption->signal)
	{
	case SIGNAL_WAIT:
		printf("%05u - SIGNAL - WAIT\n", interruption->process->id);
		printf("%05u - STATE - 0x%02x\n", interruption->process->id, interruption->process->state);
		process_remove_state(interruption->process, STATE_WAITING_RES | STATE_WAITING_INS);
		process_list_push(system->ready, interruption->process);
		printf("%05u - READY\n", interruption->process->id);
		break;
	case SIGNAL_END:
		printf("%05u - SIGNAL - END\n", interruption->process->id);
		for (index = 0; index < system->size_processes; index++)
		{
			if (system->processes[index] == NULL)
				continue;
			if (system->processes[index]->parent_id != interruption->process->id)
				continue;
			system->processes[index]->parent_id = 0;
			process_set_state(system->processes[index], STATE_ZOMBIE);
			printf("%05u - STATE - ZOMBIE - 0x%02x\n", index, system->processes[index]->state);
		}
		system_destroy_process(system, interruption->process->id);
		break;
	default:
		printf("%05u - SIGNAL - 0x%02x\n", interruption->process->id, interruption->signal);
	}
	interruption_destroy(interruption);
}

void system_run_instruction(System* system)
{
	Instruction* instruction;
	if (system->current == NULL)
		return;
	instruction = process_step(system->current);
	if (instruction == NULL || !instruction_is_valid(instruction))
	{
		if (instruction == NULL)
			printf("%05u - INS #%05u - END\n", system->current->id, system->current->instruction_pointer - 1);
		else
			printf("%05u - INS #%05u - INVALID\n", system->current->id, system->current->instruction_pointer - 1);
		interruption_array_insert(system->interruptions, system->current, SIGNAL_END);
		printf("%05u - INT - END\n", system->current->id);
		system->current = NULL;
	}
	else if (instruction_is_block(instruction))
	{
		printf("%05u - INS #%05u - BLOCK\n", system->current->id, system->current->instruction_pointer - 1);
		interruption_array_insert(system->interruptions, system->current, SIGNAL_WAIT);
		process_set_state(system->current, STATE_WAITING_RES);
		printf("%05u - INT - WAITING_RES\n", system->current->id);
		system->current = NULL;
	}
	else
	{
		printf("%05u - INS #%05u - OK\n", system->current->id, system->current->instruction_pointer - 1);
		system->instructions_left--;
	}
}

void system_step(System* system)
{
	system_handle_interruption(system);
	system_ordonancement(system);
	system_run_instruction(system);
}

Bool system_destroy_process(System* system, unsigned int id)
{
	printf("%05u - KILL\n", id);
	unsigned int i;
	Bool ok = TRUE;
	if (id == 0)
		return FALSE;
	if (id >= system->size_processes)
		return FALSE;
	if (system->processes[id] == NULL)
		return FALSE;
	for (i = 0; i < system->size_processes; i++)
		if (system->processes[i] != NULL && system->processes[i]->parent_id == id)
			ok &= system_destroy_process(system, i);
	if (!ok)
		return FALSE;
	process_list_remove(system->ready, id);
	interruption_array_remove_process(system->interruptions, id, TRUE);
	process_destroy(system->processes[id]);
	system->processes[id] = NULL;
	return TRUE;
}

Bool system_can_continue(System* system)
{
	unsigned int i;
	for (i = 1; i < system->size_processes; i++)
		if (system->processes[i] != NULL)
			return TRUE;
	return FALSE;
}


void system_destroy(System* system)
{
	unsigned int i;
	process_list_destroy(system->ready);
	interruption_array_destroy(system->interruptions, TRUE);

	for (i = 0; i < system->size_processes; i++)
		if (system->processes[i] != NULL)
			process_destroy(system->processes[i]);
	free(system->processes);
	free(system);
}