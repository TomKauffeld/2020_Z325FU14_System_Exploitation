#include "Process.h"
#include <string.h>
#include <stdlib.h>


Process* process_init(unsigned int id, unsigned int parent_id)
{
	Process* process = (Process*)malloc(sizeof(Process));
	if (process == NULL)
		return NULL;
	process->nb_instructions = 0;
	process->instructions = NULL;
	process->instruction_pointer = 0;
	process->id = id;
	process->parent_id = parent_id;
	process->state = 0x00;
	return process;
}

Instruction* process_step(Process* process)
{
	Instruction* instruction;
	if (process->instruction_pointer >= process->nb_instructions)
		return NULL;
	return process->instructions[process->instruction_pointer++];
}

Instruction* process_add_instruction(Process* process, Bool valid, Bool block)
{
	Instruction** tmp;
	unsigned int index;
	Instruction* instruction = instruction_init(valid, block);
	if (instruction == NULL)
		return NULL;
	if (process->instructions == NULL)
		tmp = (Instruction**)malloc(sizeof(Instruction*));
	else
		tmp = (Instruction**)realloc(process->instructions, sizeof(Instruction*) * (process->nb_instructions + 1));
	if (tmp == NULL)
		return NULL;
	process->instructions = tmp;
	process->instructions[process->nb_instructions++] = instruction;
	return instruction;
}

void process_set_state(Process* process, Flags flags)
{
	flags_set(&(process->state), flags);
}

void process_remove_state(Process* process, Flags flags)
{
	flags_remove(&(process->state), flags);
}

Bool process_has_state(Process* process, Flags flags)
{
	return flags_has(process->state, flags);
}

void process_destroy(Process* process)
{
	unsigned int i;
	if (process->nb_instructions > 0)
	{
		for (i = 0; i < process->nb_instructions; i++)
			if (process->instructions[i] != NULL)
				instruction_destroy(process->instructions[i]);
		free(process->instructions);
	}
	free(process);
}
