#include "InterruptionArray.h"
#include <stdlib.h>

InterruptionArray* interruption_array_init()
{
	InterruptionArray* arr = (InterruptionArray*)malloc(sizeof(InterruptionArray));
	if (arr == NULL)
		return NULL;
	arr->data = NULL;
	arr->size = 0;
	arr->nb_items = 0;
	return arr;
}

Interruption* interruption_array_get(InterruptionArray* arr, unsigned int index)
{
	if (index >= arr->nb_items)
		return NULL;
	return arr->data[index];
}

Interruption* interruption_array_set(InterruptionArray* arr, unsigned int index, Interruption* interruption)
{
	Interruption* oldvalue;
	if (index >= arr->nb_items)
		return NULL;
	oldvalue = arr->data[index];
	arr->data[index] = interruption;
	return oldvalue;
}

unsigned int interruption_array_push(InterruptionArray* arr, Interruption* interruption)
{
	Interruption** tmp;
	if (arr->data == NULL)
	{
		arr->data = (Interruption**)malloc(sizeof(Interruption*));
		if (arr->data == NULL)
			return UINT_MAX;
	}
	else if (arr->nb_items >= arr->size)
	{
		tmp = (Interruption**)realloc(arr->data, sizeof(Interruption*) * (arr->size + 1));
		if (tmp == NULL)
			return UINT_MAX;
		arr->data = tmp;
		arr->size++;
	}
	arr->data[arr->nb_items] = interruption;
	return arr->nb_items++;
}

Interruption* interruption_array_insert(InterruptionArray* arr, Process* process, unsigned char signal)
{
	unsigned int index;
	Interruption* interruption = interruption_init(process, signal);
	if (interruption == NULL)
		return NULL;
	index = interruption_array_push(arr, interruption);
	if (index == UINT_MAX)
	{
		interruption_destroy(interruption);
		return NULL;
	}
	return interruption;
}

Interruption* interruption_array_remove(InterruptionArray* arr, unsigned int index)
{
	Interruption* oldvalue;
	unsigned int i;
	if (index >= arr->nb_items)
		return NULL;
	oldvalue = arr->data[index];
	for (i = index + 1; i < arr->nb_items; i++)
		arr->data[i - 1] = arr->data[i];
	arr->data[arr->nb_items - 1] = NULL;
	arr->nb_items--;
	return oldvalue;
}

void interruption_array_remove_process(InterruptionArray* arr, unsigned int id, Bool free_children)
{
	unsigned int i;
	Interruption* tmp;
	for (i = arr->nb_items; i > 0; i--)
	{
		if (arr->data[i-1]->process->id == id)
		{
			tmp = interruption_array_remove(arr, i-1);
			if (is_true(free_children))
				interruption_destroy(tmp);
		}
	}
}

unsigned int interruption_array_size(InterruptionArray* arr)
{
	return arr->nb_items;
}

void interruption_array_destroy(InterruptionArray* arr, Bool free_children)
{
	unsigned int i;
	if (arr->data != NULL)
	{
		if (is_true(free_children))
			for (i = 0; i < arr->nb_items; i++)
				interruption_destroy(arr->data[i]);
		free(arr->data);
	}
	free(arr);
}
