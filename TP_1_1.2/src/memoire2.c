#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>
#include <string.h>

#include "memoire2.h"
#include "list.h" //vous pouvez remplacer par votre implÃ©mentation de liste favorite

enum blocLibre { Libre, Utilise};

struct bloc {
	int debut;
	int taille;
	enum blocLibre drapeau;
};

struct memoire {
	int tailleMot;
	int nbMots;
	list listBlocs;
};

memoire creerMemoire(int tailleMot, int nbMots)
{
	memoire m = (memoire)malloc(sizeof(struct memoire));
	if (m == NULL)
	{
		printf("ERROR : couldn't allocate memory\n");
		return NULL;
	}
	m->nbMots = nbMots;
	m->tailleMot = tailleMot;
	m->listBlocs = creer_list();
	if (m->listBlocs == NULL)
	{
		printf("ERROR : couldn't allocate memory\n");
		free(m);
		return NULL;
	}
	bloc b = (bloc)malloc(sizeof(struct bloc));
	if (b == NULL)
	{
		printf("ERROR : couldn't allocate memory\n");
		free(m);
		return NULL;
	}
	b->debut = 0;
	b->taille = tailleMot * nbMots;
	b->drapeau = Libre;
	inserer_objet(m->listBlocs, b, 0);
	return m;
}

bloc allocationMemoire(memoire mem, int tailleAAllouer)
{
	int nbMots = tailleAAllouer / mem->tailleMot;
	if (tailleAAllouer % mem->tailleMot > 0)
		nbMots++;
	int index = 1;
	bloc freeBloc = NULL;
	void* tmp;
	while ((tmp = objet(mem->listBlocs, ++index)) != NULL)
		if (((bloc)tmp)->drapeau == Libre && mem->tailleMot * nbMots < ((bloc)tmp)->taille)
			freeBloc = (bloc)tmp;
	if (freeBloc == NULL)
	{
		printf("ERROR : no memory free\n");
		return NULL;
	}
	bloc b = (bloc)malloc(sizeof(struct bloc));
	if (b == NULL)
	{
		printf("ERROR : couldn't allocate memory\n");
		return NULL;
	}
	b->debut = freeBloc->debut;
	b->taille = mem->tailleMot * nbMots;
	b->drapeau = Utilise;
	freeBloc->debut += b->taille;
	freeBloc->taille -= b->taille;
	if (freeBloc->taille <= 0)
		mem->listBlocs = liberer_objet(mem->listBlocs, index);
	inserer_objet(mem->listBlocs, b, index-1);
	return b;
}

void liberationMemoire(memoire mem, bloc blocALiberer)
{
	if (blocALiberer->drapeau == Libre)
		return;
	blocALiberer->drapeau = Libre;
	unsigned char run = 1;
	int bal = 1;
	void* tmp;
	while ((tmp = objet(mem->listBlocs, ++bal)) != NULL && blocALiberer->debut != ((bloc)tmp)->debut);
	int index;
	bloc b;
	while (run)
	{
		run = 0;
		index = 1;
		while ((tmp = objet(mem->listBlocs, ++index)) != NULL)
		{
			b = (bloc)tmp;
			if (b->drapeau != Libre)
				continue;
			if (b->debut + b->taille == blocALiberer->debut)
			{
				b->taille += blocALiberer->taille;
				mem->listBlocs = liberer_objet(mem->listBlocs, bal);
				free(blocALiberer);
				bal = index;
				blocALiberer = b;
				run = 1;
				break;
			}
			if (blocALiberer->debut + blocALiberer->taille == b->debut)
			{
				blocALiberer->taille += b->taille;
				mem->listBlocs = liberer_objet(mem->listBlocs, index);
				free(b);
				if (index < bal)
					bal--;
				run = 1;
				break;
			}
		}
	}
}


void show_memory(memoire mem, char* text)
{
	int index = 1;
	bloc b;
	void* tmp;
	printf("Memoire : ");
	if (text != NULL)
		printf("%s", text);
	printf("\n");
	printf("Word    : %d\n", mem->tailleMot);
	printf("Size    : %d\n", mem->nbMots);
	while ((tmp = objet(mem->listBlocs, ++index)) != NULL)
	{
		b = (bloc)tmp;
		printf("\t[%04x %04x %04d ", b->debut, b->debut + b->taille, b->taille);
		if (b->drapeau == Libre)
			printf("F");
		else
			printf("U");
		printf("]\n");
	}
}